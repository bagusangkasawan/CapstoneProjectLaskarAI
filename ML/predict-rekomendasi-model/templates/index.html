<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EnergyMate - AI Prediction</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background: linear-gradient(135deg, #673ab7, #ff9800);
        margin: 0;
        padding: 0;
        color: #333;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
      }

      .container {
        background-color: #fff;
        padding: 30px 40px;
        border-radius: 12px;
        max-width: 600px;
        width: 100%;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }

      h1 {
        text-align: center;
        margin-bottom: 20px;
        color: #8e24aa;
      }

      .input-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }

      input {
        width: 100%;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 8px;
        outline: none;
      }

      button {
        width: 100%;
        padding: 12px;
        background-color: #ff5722;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      button:hover {
        background-color: #e64a19;
      }

      .result {
        margin-top: 20px;
        background-color: #f3f3f3;
        padding: 15px;
        border-radius: 8px;
      }

      .result h3 {
        margin-top: 0;
        color: #4a148c;
      }

      .alat-entry {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }

      .alat-entry input {
        flex: 1;
      }

      .add-btn {
        background-color: #4caf50;
        margin-bottom: 15px;
      }

      .add-btn:hover {
        background-color: #388e3c;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ðŸ”‹ EnergyMate Prediction</h1>
      <div class="alat-wrapper" id="alat-wrapper">
        <div class="alat-entry">
          <select class="alat-nama" required>
            <option value="" disabled selected>Pilih Alat</option>
            <option value="microwave">Microwave</option>
            <option value="rice cooker">Rice Cooker</option>
            <option value="blender">Blender</option>
            <option value="washing machine">Washing Machine</option>
            <option value="dryer">Dryer</option>
            <option value="iron">Iron</option>
            <option value="water heater">Water Heater</option>
            <option value="ac">AC</option>
            <option value="vacuum cleaner">Vacuum Cleaner</option>
          </select>
          <input
            type="number"
            placeholder="Jumlah unit"
            class="alat-jumlah"
            min="1"
            value="1"
            required
          />
          <input
            type="number"
            placeholder="Durasi (jam)"
            class="alat-jam"
            min="0"
            step="0.1"
            value="1"
            required
          />
        </div>
      </div>

      <button type="button" class="add-btn" onclick="addAlat()">
        + Tambah Alat
      </button>

      <div class="input-group">
        <label for="hour">Jam Sekarang (0 - 23)</label>
        <input type="number" id="hour" min="0" max="23" required />
      </div>

      <button type="button" onclick="submitForm()">Predict & Recommend</button>

      <div id="result" class="result" style="display: none">
        <h3>Prediction Result</h3>
        <p id="prediction"></p>
        <h3>Recommendation</h3>
        <p id="recommendation"></p>
      </div>
    </div>

    <script>
      const appliancePower = {
        microwave: 0.8,
        "rice cooker": 0.6,
        blender: 0.3,
        "washing machine": 1.0,
        dryer: 1.2,
        iron: 1.1,
        "water heater": 1.5,
        ac: 1.3,
        "vacuum cleaner": 0.9,
      };

      const applianceToSub = {
        microwave: "Sub_metering_1",
        "rice cooker": "Sub_metering_1",
        blender: "Sub_metering_1",
        "washing machine": "Sub_metering_2",
        dryer: "Sub_metering_2",
        iron: "Sub_metering_2",
        "water heater": "Sub_metering_3",
        ac: "Sub_metering_3",
        "vacuum cleaner": "Sub_metering_3",
      };

      function addAlat() {
        const wrapper = document.getElementById("alat-wrapper");
        const alatEntry = document.createElement("div");
        alatEntry.className = "alat-entry";
        alatEntry.innerHTML = `
        <select class="alat-nama" required>
          <option value="" disabled selected>Pilih Alat</option>
          <option value="microwave">Microwave</option>
          <option value="rice cooker">Rice Cooker</option>
          <option value="blender">Blender</option>
          <option value="washing machine">Washing Machine</option>
          <option value="dryer">Dryer</option>
          <option value="iron">Iron</option>
          <option value="water heater">Water Heater</option>
          <option value="ac">AC</option>
          <option value="vacuum cleaner">Vacuum Cleaner</option>
        </select>
        <input type="number" placeholder="Jumlah unit" class="alat-jumlah" min="1" value="1" required />
        <input type="number" placeholder="Durasi (jam)" class="alat-jam" min="0" step="0.1" value="1" required />
      `;
        wrapper.appendChild(alatEntry);
      }

      function submitForm() {
        let sm1 = 0,
          sm2 = 0,
          sm3 = 0;
        const intensity = ((sm1 + sm2 + sm3) * 1000) / 230;
        const hour = parseInt(document.getElementById("hour").value);
        const entries = document.querySelectorAll(".alat-entry");

        entries.forEach((e) => {
          const nama = e.querySelector(".alat-nama").value;
          const jumlah = +e.querySelector(".alat-jumlah").value;
          const durasi = +e.querySelector(".alat-jam").value;
          const powerPerHour = appliancePower[nama] || 0;
          const sub = applianceToSub[nama];
          const usage = powerPerHour * jumlah * durasi;
          if (sub === "Sub_metering_1") sm1 += usage;
          else if (sub === "Sub_metering_2") sm2 += usage;
          else if (sub === "Sub_metering_3") sm3 += usage;
        });

        const payload = {
          Global_intensity: intensity,
          Sub_metering_1: sm1,
          Sub_metering_2: sm2,
          Sub_metering_3: sm3,
          hour: hour,
        };

        fetch("/api/predict/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        })
          .then((r) => r.json())
          .then((data) => {
            document.getElementById("result").style.display = "block";

            let breakdown = data.breakdown;
            let breakdownText = Object.entries(breakdown)
              .map(([key, val]) => `${key}: ${val.toFixed(2)} kWh`)
              .join("<br>");

            document.getElementById("prediction").innerHTML = `
                      Total Pemakaian: ${data.total_usage_kw} kWh<br>
                      Prediksi Konsumsi: ${data.prediction_kw} kWh<br>
                      Kategori: ${data.category}<br><br>
                      <strong>Rincian:</strong><br>
                      ${breakdownText}
                  `;

            document.getElementById("recommendation").innerHTML = `
                      Rekomendasi Umum: ${data.general_recommendation}<br>
                      Fokus: ${data.focus_area}<br>
                      Saran Spesifik: ${data.specific_recommendation}
                  `;
          })
          .catch(console.error);
      }
    </script>
  </body>
</html>
